/**
 * NotificationManager.js
 * Â© 2025 Hamza Nawabi. All rights reserved.
 * Email: hamza.nawabi119@gmail.com
 * WhatsApp: +93 766420877
 * Created: March 18, 2025
 */

class NotificationManager {
    constructor(serviceWorkerPath = "/sw.js") {
      this.serviceWorkerPath = serviceWorkerPath;
      this.initServiceWorker();
    }
  
    // Register Service Worker
    async initServiceWorker() {
      if ("serviceWorker" in navigator) {
        try {
          const reg = await navigator.serviceWorker.register(
            this.serviceWorkerPath
          );
          console.log("âœ… Service Worker Registered");
        } catch (error) {
          console.error("âŒ SW Registration Failed:", error);
        }
      } else {
        console.warn("âš ï¸ Service Worker not supported in this browser.");
      }
    }
  
    // Request Notification Permission
    async requestPermission() {
      try {
        const permission = await Notification.requestPermission();
        if (permission !== "granted") {
          console.warn("âš ï¸ Notifications permission denied.");
        }
        return permission;
      } catch (error) {
        console.error("âŒ Error requesting permission:", error);
        return "denied";
      }
    }
  
    // Send Notification
    async sendNotification(title, body, icon = false, tag = false, url = false) {
      console.log("ğŸ”” Sending notification...");
      if (!("Notification" in window)) {
        console.warn("ğŸš¨ Notifications not supported.");
        return;
      }
      if (Notification.permission !== "granted") {
        console.warn("ğŸš¨ Notifications are not allowed.");
        return;
      }
      const options = {
        body: body || "You have a new message.",
        icon:
          icon ||
          "https://uxwing.com/wp-content/themes/uxwing/download/communication-chat-call/two-way-chat-bubble-icon.png",
        tag: tag || "notify",
        data: { url: url || "https://github.com/Nawabi-Hamza" },
      };
  
      try {
        if ("serviceWorker" in navigator) {
          const reg = await navigator.serviceWorker.getRegistration();
          if (reg) {
            reg.showNotification(title, options);
            console.log("âœ… Notification sent via Service Worker");
          } else {
            console.warn("ğŸš¨ Service Worker not registered yet.");
            new Notification(title, options);
            console.log("âœ… Notification sent via Notification API");
          }
        } else {
          new Notification(title, options);
          console.log("âœ… Notification sent via Notification API");
        }
      } catch (error) {
        console.error("âŒ Error sending notification:", error);
      }
    }
  
    // âœ… Auto Reminder When User Leaves
    autoNotifyWhenHidden(title, body, icon = false, tag = false, url = false, interval = 60000) {
      document.addEventListener("visibilitychange", () => {
        const finalURL = url || "https://github.com/Nawabi-Hamza";
        if (document.visibilityState === "hidden") {
          if (this.hiddenInterval) return; // âœ… Prevent duplicate intervals
  
          this.hiddenInterval = setInterval(() => {
            this.sendNotification(title, body, icon, tag, finalURL);
          }, interval);
        } else {
          clearInterval(this.hiddenInterval);
          this.hiddenInterval = null;
          this.sendNotification(
            "Welcome Back!",
            "ğŸ‘‹ğŸ» We're happy to see you!",
            icon,
            tag,
            finalURL
          );
        }
      });
    }
  }
// âœ… Make it available globally
window.NotificationManager = NotificationManager;